// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(uuid())
  keycloakId String   @unique
  email      String   @unique
  name       String
  brand      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  connectedAccounts ConnectedAccount[]
  calendarEvents    CalendarEvent[]
  meetingPreference MeetingPreference?
  automations       Automation[]
  socialPosts       SocialPost[]
}

model PlannerProject {
  id              String             @id @default(cuid())
  name            String
  color           String
  defaultActivity String
  blockedBy       String[]           @default([])
  templates       PlannerTemplate[]
  entries         PlannerEntry[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model PlannerTemplate {
  id           String         @id @default(cuid())
  name         String
  icon         String
  activityType String
  hours        Float
  description  String
  projectId    String
  project      PlannerProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model PlannerEntry {
  id           String         @id @default(cuid())
  userId       String
  date         DateTime       @db.Date
  activityType String
  hours        Float
  description  String
  projectId    String
  project      PlannerProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([userId, date])
  @@index([date])
}

model ChatRoom {
  id           String        @id @default(cuid())
  slug         String        @unique
  name         String
  description  String
  theme        String
  participants String[]      @default([])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  messages     ChatMessage[]
}

model ChatMessage {
  id         String    @id @default(cuid())
  roomId     String
  senderId   String
  senderName String
  body       String
  createdAt  DateTime  @default(now())
  room       ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, createdAt])
}

enum ConnectedProvider {
  GOOGLE_CALENDAR
  LINKEDIN
  FACEBOOK
}

enum MeetingPlatform {
  ZOOM
  GOOGLE_MEET
  MICROSOFT_TEAMS
  UNKNOWN
}

enum CalendarEventStatus {
  UPCOMING
  COMPLETED
  CANCELLED
}

enum RecallBotStatus {
  SCHEDULED
  JOINING
  IN_CALL
  DONE
  FATAL
  CANCELLED
}

enum MeetingMediaType {
  TRANSCRIPT
  VIDEO
  PARTICIPANT_EVENTS
  AUDIO
  METADATA
}

enum MeetingMediaStatus {
  PENDING
  STORED
  FAILED
}

enum SocialChannel {
  LINKEDIN
  FACEBOOK
}

enum SocialPostStatus {
  DRAFT
  READY
  POSTING
  POSTED
  FAILED
}

model ConnectedAccount {
  id                 String            @id @default(uuid())
  userId             String
  provider           ConnectedProvider
  providerAccountId  String
  label              String?
  scopes             String[]          @default([])
  accessToken        String?
  refreshToken       String?
  expiresAt          DateTime?
  lastSyncedAt       DateTime?
  metadata           Json?
  linkedAt           DateTime          @default(now())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  calendarEvents     CalendarEvent[]

  @@index([userId, provider])
  @@unique([provider, providerAccountId])
}

model MeetingPreference {
  id                  String   @id @default(uuid())
  userId              String   @unique
  leadMinutes         Int      @default(10)
  defaultNotetaker    Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CalendarEvent {
  id                  String              @id @default(uuid())
  userId              String
  connectedAccountId  String
  externalEventId     String
  calendarId          String?
  calendarTitle       String?
  title               String?
  description         String?
  location            String?
  meetingUrl          String?
  meetingPlatform     MeetingPlatform     @default(UNKNOWN)
  htmlLink            String?
  startTime           DateTime
  endTime             DateTime
  timezone            String?
  attendees           Json?
  reminders           Json?
  recurrence          Json?
  creatorEmail        String?
  creatorDisplayName  String?
  deduplicationKey    String
  status              CalendarEventStatus @default(UPCOMING)
  notetakerEnabled    Boolean             @default(false)
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  connectedAccount    ConnectedAccount    @relation(fields: [connectedAccountId], references: [id], onDelete: Cascade)
  recallBot           RecallBot?
  meetingInsights     MeetingInsight[]
  socialPosts         SocialPost[]

  @@unique([connectedAccountId, externalEventId])
  @@index([userId, startTime])
  @@index([deduplicationKey])
}

model RecallBot {
  id               String           @id
  calendarEventId  String           @unique
  status           RecallBotStatus  @default(SCHEDULED)
  scheduledBy      String?
  joinAt           DateTime
  meetingUrl       String
  meetingPlatform  MeetingPlatform  @default(UNKNOWN)
  leadTimeMinutes  Int              @default(10)
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  calendarEvent    CalendarEvent    @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)
  media            MeetingMedia[]
}

model MeetingMedia {
  id          String             @id @default(uuid())
  recallBotId String
  type        MeetingMediaType
  status      MeetingMediaStatus @default(PENDING)
  downloadUrl String?
  storagePath String?
  expiresAt   DateTime?
  payload     Json?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  recallBot   RecallBot          @relation(fields: [recallBotId], references: [id], onDelete: Cascade)

  @@index([recallBotId, type])
}

model MeetingInsight {
  id              String        @id @default(uuid())
  calendarEventId String
  summary         String?
  followUpEmail   String?
  actionItems     Json?
  generatedAt     DateTime?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  calendarEvent   CalendarEvent @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)
}

model Automation {
  id             String        @id @default(uuid())
  userId         String
  name           String
  channel        SocialChannel
  isEnabled      Boolean       @default(true)
  promptTemplate String
  config         Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialPosts    SocialPost[]

  @@index([userId, channel])
}

model SocialPost {
  id              String           @id @default(uuid())
  calendarEventId String
  userId          String
  automationId    String?
  channel         SocialChannel
  content         String
  status          SocialPostStatus @default(DRAFT)
  error           String?
  externalPostId  String?
  publishedAt     DateTime?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  calendarEvent   CalendarEvent    @relation(fields: [calendarEventId], references: [id], onDelete: Cascade)
  automation      Automation?      @relation(fields: [automationId], references: [id], onDelete: SetNull)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([calendarEventId, status])
  @@index([userId, channel])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  roomSlug  String?
  messageId String?
  payload   Json
  readAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([userId, readAt])
}
